# 路径约束等价性验证器使用说明

## 概述

**路径约束等价性验证器** (`path_constraint_equivalence_verifier.py`) 是一个基于Z3求解器的工具，用于验证两个不同路径约束的逻辑等价性。该工具直接使用SMT求解技术，提供准确可靠的等价性判断。

## 核心功能

### 1. 等价性验证算法
- 使用逻辑等价检查公式：`(C1 ∧ ¬C2) ∨ (¬C1 ∧ C2)`
- 如果此公式不可满足（UNSAT），则两个约束逻辑等价
- 如果此公式可满足（SAT），则两个约束不等价，并提供反例

### 2. 支持的约束格式
- 标准SMT-LIB格式文件
- 位向量（BitVec）约束
- 数值比较约束（>=、<=、>、<、=）
- 逻辑组合约束（and、or、not）

## 使用方法

### 运行完整测试套件
```bash
python path_constraint_equivalence_verifier.py
```
这将运行内置的4个测试用例，包括2个正例和2个反例。

### 验证指定的两个文件
```bash
python path_constraint_equivalence_verifier.py <file1> <file2>
```
例如：
```bash
python path_constraint_equivalence_verifier.py s000_O1_path_1.txt s000_O1_path_2.txt
```

## 测试用例说明

### 正例（等价约束）

#### 测试1：分离约束vs合并约束
- **约束A**: `(assert (bvuge x (_ bv5 32))) (assert (bvule x (_ bv10 32)))`
- **约束B**: `(assert (and (bvuge x (_ bv5 32)) (bvule x (_ bv10 32))))`
- **结果**: 等价 ✅

#### 测试2：德摩根定律等价变换
- **约束A**: `(assert (or (bvult y (_ bv3 32)) (bvugt y (_ bv7 32))))`
- **约束B**: `(assert (not (and (bvuge y (_ bv3 32)) (bvule y (_ bv7 32)))))`
- **结果**: 等价 ✅

### 反例（不等价约束）

#### 测试3：不同数值范围
- **约束A**: `x >= 5 && x <= 10`
- **约束B**: `x >= 6 && x <= 10`
- **反例**: x = 5 使得约束A为真，约束B为假
- **结果**: 不等价 ❌

#### 测试4：完全不同的等值约束
- **约束A**: `w == 0`
- **约束B**: `w == 1`
- **反例**: w = 0 使得约束A为真，约束B为假
- **结果**: 不等价 ❌

## 输出信息解释

### 验证过程
1. **步骤1**: 解析约束文件，转换为Z3内部表示
2. **步骤2**: 显示约束的逻辑结构
3. **步骤3**: 构建等价性检查公式并求解
4. **步骤4**: 输出验证结果和统计信息

### 结果类型
- 🟢 **等价**: 两个约束在逻辑上等价
- 🔴 **不等价**: 两个约束不等价，提供反例模型
- 🟡 **无法确定**: 求解超时或未知状态

### 反例信息
当约束不等价时，工具会提供：
- **反例模型**: 具体的变量赋值
- **反例验证**: 显示两个约束在该赋值下的真值

## 性能特点

- **快速求解**: 大多数简单约束在毫秒级别完成
- **内存优化**: 使用Z3的上下文管理避免内存泄漏
- **超时控制**: 默认30秒超时，避免无限等待

## 技术细节

### Z3求解器配置
- 超时时间：30000毫秒（30秒）
- 使用统一的Z3上下文避免变量冲突
- 支持SMT-LIB 2.0标准格式

### 错误处理
- 自动过滤注释和无效行
- 处理不完整的SMT语法
- 提供详细的错误信息

## 应用场景

1. **符号执行验证**: 验证不同路径的约束是否等价
2. **编译器优化**: 验证优化前后约束的等价性
3. **程序分析**: 比较不同分析结果的一致性
4. **测试用例生成**: 识别真正不同的路径约束

## 示例运行结果

```
============================================================
验证路径约束等价性: 正例1 - 分离约束vs合并约束
约束文件1: test_constraint_1a.smt
约束文件2: test_constraint_1b.smt
============================================================
步骤1: 解析约束文件...
约束解析完成，耗时: 0.023 秒

步骤2: 约束信息分析
约束1: And(UGE(x, 5), ULE(x, 10))
约束2: And(UGE(x, 5), ULE(x, 10))

步骤3: 等价性验证
使用逻辑等价检查方法: (C1 ∧ ¬C2) ∨ (¬C1 ∧ C2)
如果此公式不可满足(UNSAT)，则C1 ≡ C2
正在求解...

步骤4: 验证结果
求解状态: unsat
验证耗时: 0.011 秒
总耗时: 0.034 秒
🟢 结论: 两个路径约束在逻辑上等价
   解释: 等价检查公式不可满足，表明不存在使两约束真值不同的赋值
```

## 注意事项

1. 确保输入文件为有效的SMT-LIB格式
2. 大型约束可能需要较长的求解时间
3. 复杂的非线性约束可能导致超时
4. 建议在验证前检查约束文件的语法正确性 